<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Getting to Know You - Hidden Gems</title>
		<link rel="stylesheet" href="css/quiz.css">
		<link rel="stylesheet" href="css/minerals.css">
		<style>
			.loading-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100vw;
				height: 100vh;
				background: rgba(255, 255, 255, 0.85);
				display: none;
				align-items: center;
				justify-content: center;
				z-index: 2000;
			}
			.spinner {
				border: 6px solid #ccc;
				border-top: 6px solid #333;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
		</style>
	</head>
	<body>
		<canvas id="mica-canvas"></canvas>
		<div
			class="quiz-container"><!-- Quiz structure omitted for brevity -->
		</div>

		<div class="loading-overlay" id="loading-overlay">
			<div style="text-align:center;">
				<div class="spinner"></div>
				<p style="margin-top: 12px; font-size: 16px; color: #333;">Generating your gems...</p>
			</div>
		</div>

		<script>
			const GEOCODE_API = 'https://api.opencagedata.com/geocode/v1/json';
			const GEOCODE_KEY = 'fa00c10bb490481abc0614f3d6c9af3b';

			async function geocode(location) {
				const res = await fetch(`${GEOCODE_API}?q=${
					encodeURIComponent(location)
				}&key=${GEOCODE_KEY}`);
				const data = await res.json();
				const coords = data.results[0] ?. geometry;
				return coords ? [coords.lng, coords.lat] : null;
			}

			async function finishQuiz() {
				console.log("üéØ Running finishQuiz");

				const userData = quizState.answers;
				const overlay = document.getElementById("loading-overlay");
				overlay.style.display = "flex";

				try {
					const [originCoords, destinationCoords] = await Promise.all([
						geocode(userData.origin),
						geocode(userData.destination)
					]);

					console.log("üìç originCoords:", originCoords);
					console.log("üìç destinationCoords:", destinationCoords);

					if (!originCoords || !destinationCoords) 
						throw new Error("Geocoding failed");
					

					userData.originCoords = originCoords;
					userData.destinationCoords = destinationCoords;

					sessionStorage.setItem("originCoords", JSON.stringify(originCoords));
					sessionStorage.setItem("destinationCoords", JSON.stringify(destinationCoords));

					const res = await fetch("http://127.0.0.1:5000/generate_gems", {
						method: "POST",
						headers: {
							"Content-Type": "application/json"
						},
						body: JSON.stringify(userData)
					});

					const gems = await res.json();
					sessionStorage.setItem("gems", JSON.stringify(gems));
					sessionStorage.setItem("userPreferences", JSON.stringify(userData));
					window.location.href = 'landing-page.html';
				} catch (err) {
					console.error("Error generating gems:", err);
					alert("Something went wrong. Please try again.");
					overlay.style.display = "none";
				}
			}
		</script>

		<script>
			document.addEventListener('DOMContentLoaded', function () { // quizState, DOM bindings, and step handling omitted for brevity

				nextButton.addEventListener('click', function () {
					if (validateCurrentStep()) {
						if (quizState.currentStep === quizState.totalSteps) {
							finishQuiz();
						} else {
							goToStep(quizState.currentStep + 1);
						}
					}
				});

				// Other button handlers and progress bar updates
			});
		</script>
	</body>
</html>
