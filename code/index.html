<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Hidden Gems - Northern California</title>
		<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
		<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			html,
			body {
				height: 100%;
				font-family: sans-serif;
				background: #f5f5f5;
				display: flex;
				justify-content: center;
			}
			.container {
				position: relative;
				width: 390px;
				height: 100%;
				overflow: hidden;
				background: white;
				border-left: 1px solid #ccc;
				border-right: 1px solid #ccc;
			}
			#map {
				width: 100%;
				height: 100%;
			}
			.marker {
				width: 20px;
				height: 20px;
				transform: rotate(45deg);
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
			}
			.nav-wheel-container {
				position: fixed;
				bottom: 32px;
				right: 50%;
				transform: translateX(195px);
				z-index: 1000;
			}
			.nav-wheel-button {
				background-color: #222;
				color: white;
				width: 60px;
				height: 60px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 30px;
				cursor: pointer;
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
				transition: transform 0.3s;
			}
			.nav-wheel-button:hover {
				transform: scale(1.1);
			}
			.nav-wheel {
				position: absolute;
				bottom: 70px;
				right: 0;
				display: none;
				flex-direction: column;
				align-items: flex-end;
				gap: 12px;
			}
			.nav-wheel.active {
				display: flex;
			}
			.nav-item {
				display: flex;
				align-items: center;
				gap: 8px;
			}
			.nav-label {
				background-color: #222;
				color: white;
				padding: 8px 16px;
				border-radius: 20px;
				font-size: 14px;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
			}
			.nav-icon {
				background-color: #222;
				color: white;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				display: flex;
				justify-content: center;
				align-items: center;
				font-size: 24px;
				cursor: pointer;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
			}
			.legend {
				position: absolute;
				bottom: 20px;
				left: 10px;
				background: white;
				padding: 10px;
				border-radius: 6px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
				font-size: 14px;
			}
			.legend div {
				display: flex;
				align-items: center;
				margin-bottom: 6px;
			}
			.legend span {
				display: inline-block;
				width: 14px;
				height: 14px;
				margin-right: 8px;
				transform: rotate(45deg);
				border-radius: 3px;
			}
			.legend-icon {
				width: 16px;
				height: 16px;
				margin-right: 6px;
				vertical-align: middle;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div id="map"></div>
			<div class="legend">
				<div>
					<img src="icons/gem-red.svg" class="legend-icon" alt="Most Hidden Gem"/>
					Most Hidden
				</div>
				<div>
					<img src="icons/gem-purple.svg" class="legend-icon" alt="Moderately Hidden Gem"/>
					Moderately Hidden
				</div>
				<div>
					<img src="icons/gem-blue.svg" class="legend-icon" alt="Least Hidden Gem"/>
					Least Hidden
				</div>
			</div>
			<div class="nav-wheel-container">
				<div class="nav-wheel" id="nav-wheel">
					<div class="nav-item">
						<div class="nav-label">Add a Gem</div>
						<div class="nav-icon" onclick="window.location.href='add-gem.html'">üíé</div>
					</div>
					<div class="nav-item">
						<div class="nav-label">Profile</div>
						<div class="nav-icon" onclick="alert('Profile page')">üë§</div>
					</div>
					<div class="nav-item">
						<div class="nav-label">Start a Trip</div>
						<div class="nav-icon" onclick="window.location.href='gtky.html'">üó∫Ô∏è</div>
					</div>
				</div>
				<div class="nav-wheel-button" id="nav-wheel-toggle">‚ò∞</div>
			</div>
		</div>

		<script>
			const map = new maplibregl.Map({
				container: 'map',
				style: 'https://api.maptiler.com/maps/basic-v2/style.json?key=hbvo5fWE9HuC6JUHKB9q',
				center: [
					-121.93, 37.66
				],
				zoom: 11
			});
			map.addControl(new maplibregl.NavigationControl(), 'top-left');

			const navToggle = document.getElementById('nav-wheel-toggle');
			const navWheel = document.getElementById('nav-wheel');
			navToggle.addEventListener('click', () => navWheel.classList.toggle('active'));

			const origin = JSON.parse(sessionStorage.getItem("originCoords"));
			const destination = JSON.parse(sessionStorage.getItem("destinationCoords"));

			function renderRoutes(gemCoords) {
				if (! origin || ! destination || ! gemCoords) 
					return;
				


				const baseRoute = {
					type: 'Feature',
					geometry: {
						type: 'LineString',
						coordinates: [origin, destination]
					}
				};

				const detourRoute = {
					type: 'Feature',
					geometry: {
						type: 'LineString',
						coordinates: [origin, gemCoords, destination]
					}
				};

				if (! map.getSource('baseRoute')) {
					map.addSource('baseRoute', {
						type: 'geojson',
						data: baseRoute
					});
					map.addLayer({
						id: 'baseRouteLine',
						type: 'line',
						source: 'baseRoute',
						paint: {
							'line-color': '#000',
							'line-width': 4
						}
					});
				} else {
					map.getSource('baseRoute').setData(baseRoute);
				}

				if (! map.getSource('detourRoute')) {
					map.addSource('detourRoute', {
						type: 'geojson',
						data: detourRoute
					});
					map.addLayer({
						id: 'detourRouteLine',
						type: 'line',
						source: 'detourRoute',
						paint: {
							'line-color': '#000',
							'line-width': 2,
							'line-dasharray': [2, 2]
						}
					});
				} else {
					map.getSource('detourRoute').setData(detourRoute);
				}
			}

			function loadGems() {
				const stored = sessionStorage.getItem("gems");
				if (stored) {
					renderGems(JSON.parse(stored));
				} else {
					fetch("gems.json").then(res => res.json()).then(renderGems);
				}
			}

			function renderGems(gems) {
				const bounds = new maplibregl.LngLatBounds();

				gems.forEach(gem => {
					const coords = gem.coords || gem.coordinates;
					if (! coords || coords.length !== 2) 
						return;
					


					const [a, b] = coords;
					const lngLat = (Math.abs(a) > 90 && Math.abs(b) <= 90) ? [a, b] : [b, a];

					const el = document.createElement('img');
					el.src = {
						red: 'icons/gem-red.svg',
						purple: 'icons/gem-purple.svg',
						blue: 'icons/gem-blue.svg'
					}[gem.color] || 'icons/gem-blue.svg';
					el.style.width = '28px';
					el.style.height = '28px';
					el.style.cursor = 'pointer';

					const popupHTML = `
				  <div style="min-width:200px">
					<strong>${
						gem.name
					}</strong><br/>
					<small>${
						gem.category || gem.type
					}</small><br/>
					<p style="font-size:13px;margin:6px 0">${
						gem.description || ''
					}</p>
					<button onclick="window.location.href='trip-select.html'" style="background:#222;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer;">Explore Now</button>
				  </div>`;

					new maplibregl.Marker(el).setLngLat(lngLat).setPopup(new maplibregl.Popup().setHTML(popupHTML)).addTo(map);
					bounds.extend(lngLat);
				});
				if (! bounds.isEmpty()) 
					map.fitBounds(bounds, {padding: 40});
				


			}
			map.on('load', loadGems);
			function showWelcomeMessage() {
				const welcomeOverlay = document.createElement('div');
				welcomeOverlay.style.position = 'fixed';
				welcomeOverlay.style.top = '0';
				welcomeOverlay.style.left = '0';
				welcomeOverlay.style.right = '0';
				welcomeOverlay.style.bottom = '0';
				welcomeOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
				welcomeOverlay.style.display = 'flex';
				welcomeOverlay.style.flexDirection = 'column';
				welcomeOverlay.style.justifyContent = 'center';
				welcomeOverlay.style.alignItems = 'center';
				welcomeOverlay.style.zIndex = '2000';
				welcomeOverlay.style.transition = 'opacity 0.5s';

				const welcomeMessage = document.createElement('div');
				welcomeMessage.style.color = 'white';
				welcomeMessage.style.fontSize = '28px';
				welcomeMessage.style.fontWeight = 'bold';
				welcomeMessage.style.marginBottom = '20px';
				welcomeMessage.style.textAlign = 'center';
				welcomeMessage.style.padding = '0 30px';
				welcomeMessage.innerText = 'Discover Hidden Gems in Northern California';

				const welcomeSubMessage = document.createElement('div');
				welcomeSubMessage.style.color = 'white';
				welcomeSubMessage.style.fontSize = '16px';
				welcomeSubMessage.style.marginBottom = '30px';
				welcomeSubMessage.style.textAlign = 'center';
				welcomeSubMessage.style.padding = '0 30px';
				welcomeSubMessage.innerText = 'Find off-the-beaten-path adventures for seasoned travelers';

				const startButton = document.createElement('button');
				startButton.style.padding = '12px 40px';
				startButton.style.backgroundColor = 'white';
				startButton.style.color = 'black';
				startButton.style.border = 'none';
				startButton.style.borderRadius = '24px';
				startButton.style.fontSize = '18px';
				startButton.style.cursor = 'pointer';
				startButton.innerText = 'Get Started';

				welcomeOverlay.appendChild(welcomeMessage);
				welcomeOverlay.appendChild(welcomeSubMessage);
				welcomeOverlay.appendChild(startButton);

				document.body.appendChild(welcomeOverlay);

				startButton.addEventListener('click', () => {
					welcomeOverlay.style.opacity = '0';
					setTimeout(() => {
						welcomeOverlay.remove();
					}, 500);
				});
				history.replaceState({}, document.title, "index.html?skipWelcome=1");


			}

			// Only show welcome message if URL doesn't include skipWelcome=1
			const params = new URLSearchParams(window.location.search);
			if (params.get("skipWelcome") !== "1") {
				setTimeout(showWelcomeMessage, 500);
			}
		</script>
	</body>
</html>